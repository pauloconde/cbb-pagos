---
import Layout from "../layouts/Layout.astro";
import { db, Partner, Payment, eq, and, asc } from "astro:db";

// Get current date
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth(); // 0-11

// Months in Spanish
const months = [
	{ index: 0, name: "Ene" },
	{ index: 1, name: "Feb" },
	{ index: 2, name: "Mar" },
	{ index: 3, name: "Abr" },
	{ index: 4, name: "May" },
	{ index: 5, name: "Jun" },
	{ index: 6, name: "Jul" },
	{ index: 7, name: "Ago" },
	{ index: 8, name: "Sep" },
	{ index: 9, name: "Oct" },
	{ index: 10, name: "Nov" },
	{ index: 11, name: "Dic" },
];

// Fetch Data
const partners = await db
	.select()
	.from(Partner)
	.where(eq(Partner.active, true))
	.orderBy(asc(Partner.name));
const payments = await db
	.select()
	.from(Payment)
	.where(eq(Payment.year, currentYear));

// Process Data: Create a map of payments for easier access [partnerId][month] = true
const paymentMap: Record<number, Record<number, boolean>> = {};
payments.forEach((p) => {
	if (!paymentMap[p.partnerId]) paymentMap[p.partnerId] = {};
	paymentMap[p.partnerId][p.month] = true;
});

// Helper to determine status color
function getStatusClass(partnerId: number, monthIndex: number) {
	const isPaid = paymentMap[partnerId]?.[monthIndex];
	if (isPaid) {
		return "bg-emerald-500/20 text-emerald-400 border border-emerald-500/30"; // Paid
	}
	if (monthIndex <= currentMonth) {
		return "bg-red-500/10 text-red-400 border border-red-500/30"; // Pending (Past or Current)
	}
	return "bg-gray-800/50 text-gray-500 border border-gray-700/50"; // Future
}

function getStatusText(partnerId: number, monthIndex: number) {
	const isPaid = paymentMap[partnerId]?.[monthIndex];
	return isPaid ? "Pagado" : monthIndex <= currentMonth ? "Pendiente" : "";
}
---

<Layout title="Estado de Pagos - CBC">
	<main class="min-h-screen bg-gray-950 text-white p-4 md:p-8 relative">
		<div class="max-w-7xl mx-auto z-10 relative">
			<header class="flex justify-between items-center mb-10">
				<div>
					<h1
						class="text-4xl font-bold bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent"
					>
						CBC Pagos
					</h1>
					<p class="text-gray-400 mt-1">
						Estado de cuenta socios {currentYear}
					</p>
				</div>
				{
					Astro.locals.user ? (
						<a
							href="/admin"
							class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm font-medium transition-colors border border-gray-700"
						>
							Dashboard
						</a>
					) : (
						<a
							href="/login"
							class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm font-medium transition-colors border border-gray-700"
						>
							Ingreso Admin
						</a>
					)
				}
			</header>

			<div
				class="bg-gray-900/40 backdrop-blur-sm border border-white/5 rounded-2xl overflow-hidden shadow-2xl"
			>
				<div class="overflow-x-auto">
					<table class="w-full text-left border-collapse">
						<thead>
							<tr class="border-b border-gray-800 bg-gray-900/80">
								<th
									class="p-4 font-semibold text-gray-300 min-w-[200px] sticky left-0 bg-gray-900 md:bg-transparent z-10 shadow-[4px_0_24px_-2px_rgba(0,0,0,0.5)] md:shadow-none"
									>Socio</th
								>
								{
									months.map((m) => (
										<th class="p-4 text-center font-medium text-gray-400 text-sm min-w-[80px]">
											{m.name}
										</th>
									))
								}
							</tr>
						</thead>
						<tbody class="divide-y divide-gray-800/50">
							{
								partners.map((partner) => (
									<tr class="hover:bg-white/5 transition-colors group">
										<td class="p-4 font-medium text-white sticky left-0 bg-gray-950 md:bg-transparent z-10 border-r border-gray-800 md:border-none group-hover:bg-gray-900 md:group-hover:bg-transparent transition-colors">
											<div class="truncate">
												{partner.name}
											</div>
											<div class="text-xs text-gray-500 truncate">
												{partner.cedula}
											</div>
										</td>
										{months.map((m) => (
											<td class="p-2 text-center">
												<div
													class={`inline-flex items-center justify-center w-full h-10 rounded-md text-xs font-semibold transition-all ${getStatusClass(partner.id, m.index)}`}
												>
													{getStatusText(
														partner.id,
														m.index,
													) === "Pagado" ? (
														<svg
															xmlns="http://www.w3.org/2000/svg"
															class="h-5 w-5"
															viewBox="0 0 20 20"
															fill="currentColor"
														>
															<path
																fill-rule="evenodd"
																d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
																clip-rule="evenodd"
															/>
														</svg>
													) : getStatusText(
															partner.id,
															m.index,
													  ) === "Pendiente" ? (
														<span class="w-2 h-2 rounded-full bg-red-500 animate-[pulse_3s_ease-in-out_infinite]" />
													) : (
														<span class="text-gray-700">
															-
														</span>
													)}
												</div>
											</td>
										))}
									</tr>
								))
							}
						</tbody>
					</table>
				</div>
				{
					partners.length === 0 && (
						<div class="p-10 text-center text-gray-500">
							No hay socios registrados a√∫n.
						</div>
					)
				}
			</div>

			<footer class="mt-8 text-center text-gray-600 text-sm">
				<p>&copy; {currentYear} CBC. Club de Pagos.</p>
			</footer>
		</div>
	</main>
</Layout>
