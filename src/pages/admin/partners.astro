---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { db } from "../../db";
import { Partner } from "../../db/schema";
import { asc } from "drizzle-orm";

// Handle Form Submission (Add Partner)
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("action");

    if (action === "create_partner") {
        const name = formData.get("name") as string;
        const cedula = formData.get("cedula") as string;
        if (name && cedula) {
            try {
                await db.insert(Partner).values({ name, cedula });
            } catch (e) {
                console.error("Error creating partner", e);
            }
        }
    }
}

// Fetch Partners
const partners = await db.select().from(Partner).orderBy(asc(Partner.name));
---

<AdminLayout>
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">Gestión de Socios</h1>
            <p class="text-gray-400 mt-1">Administra los socios del club.</p>
        </div>
        <button
            onclick="document.getElementById('new-partner-modal').showModal()"
            class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 20 20"
                fill="currentColor"
                ><path
                    fill-rule="evenodd"
                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                    clip-rule="evenodd"></path></svg
            >
            Nuevo Socio
        </button>
    </div>

    <!-- Partners List -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="border-b border-gray-800 bg-gray-900/50">
                        <th
                            class="p-4 font-semibold text-gray-300 text-sm uppercase tracking-wider"
                            >Nombre</th
                        >
                        <th
                            class="p-4 font-semibold text-gray-300 text-sm uppercase tracking-wider"
                            >Cédula</th
                        >
                        <th
                            class="p-4 font-semibold text-gray-300 text-sm uppercase tracking-wider text-right"
                            >Acciones</th
                        >
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
                    {
                        partners.map((partner) => (
                            <tr class="hover:bg-gray-800/50 transition-colors">
                                <td class="p-4 text-white font-medium">
                                    {partner.name}
                                </td>
                                <td class="p-4 text-gray-400">
                                    {partner.cedula}
                                </td>
                                <td class="p-4 text-right">
                                    <a
                                        href={`/admin/payments?partnerId=${partner.id}`}
                                        class="text-emerald-400 hover:text-emerald-300 text-sm font-medium transition-colors"
                                    >
                                        Registrar Pago
                                    </a>
                                </td>
                            </tr>
                        ))
                    }
                    {
                        partners.length === 0 && (
                            <tr>
                                <td
                                    colspan="3"
                                    class="p-8 text-center text-gray-500"
                                >
                                    No hay socios registrados.
                                </td>
                            </tr>
                        )
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- New Partner Modal -->
    <dialog
        id="new-partner-modal"
        class="bg-transparent backdrop:bg-gray-950/80 p-0 rounded-xl shadow-2xl w-full max-w-md open:animate-fade-in group"
    >
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Nuevo Socio</h3>
                <form method="dialog">
                    <button
                        class="text-gray-400 hover:text-white transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path></svg
                        >
                    </button>
                </form>
            </div>

            <form method="post" class="space-y-4">
                <input type="hidden" name="action" value="create_partner" />

                <div class="space-y-2">
                    <label
                        for="name"
                        class="text-sm font-medium text-gray-300 block"
                        >Nombre Completo</label
                    >
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                        placeholder="Ej. Juan Pérez"
                    />
                </div>

                <div class="space-y-2">
                    <label
                        for="cedula"
                        class="text-sm font-medium text-gray-300 block"
                        >Cédula</label
                    >
                    <input
                        type="text"
                        id="cedula"
                        name="cedula"
                        required
                        class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                        placeholder="Ej. 12345678"
                    />
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <form method="dialog">
                        <button
                            class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors"
                            >Cancelar</button
                        >
                    </form>
                    <button
                        type="submit"
                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-emerald-500/20"
                        >Guardar Socio</button
                    >
                </div>
            </form>
        </div>
    </dialog>
</AdminLayout>
