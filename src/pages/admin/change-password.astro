---
import AdminLayout from "../../layouts/AdminLayout.astro";

let message = "";
let error = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const currentPassword = formData.get("currentPassword") as string;
    const newPassword = formData.get("newPassword") as string;
    const confirmPassword = formData.get("confirmPassword") as string;

    if (newPassword !== confirmPassword) {
        error = "Las contraseñas no coinciden.";
    } else if (newPassword.length < 6) {
        error = "La nueva contraseña debe tener al menos 6 caracteres.";
    } else {
        // Call API to change password
        const response = await fetch(
            new URL("/api/change-password", Astro.url),
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Cookie: Astro.request.headers.get("cookie") || "",
                },
                body: JSON.stringify({ currentPassword, newPassword }),
            },
        );

        if (response.ok) {
            message = "Contraseña cambiada exitosamente.";
        } else {
            const data = await response.text();
            error = data || "Error al cambiar la contraseña.";
        }
    }
}
---

<AdminLayout>
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Cambiar Contraseña</h1>
        <p class="text-gray-400 mt-1">
            Actualiza tu contraseña de administrador.
        </p>
    </div>

    {
        message && (
            <div class="p-4 mb-6 rounded-lg bg-emerald-900/50 text-emerald-200 border border-emerald-700">
                {message}
            </div>
        )
    }

    {
        error && (
            <div class="p-4 mb-6 rounded-lg bg-red-900/50 text-red-200 border border-red-700">
                {error}
            </div>
        )
    }

    <div
        class="bg-gray-900 border border-gray-800 rounded-xl p-6 md:p-8 max-w-md"
    >
        <form method="post" class="space-y-6">
            <div class="space-y-2">
                <label
                    for="currentPassword"
                    class="text-sm font-medium text-gray-300 block"
                >
                    Contraseña Actual
                </label>
                <input
                    type="password"
                    id="currentPassword"
                    name="currentPassword"
                    required
                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                />
            </div>

            <div class="space-y-2">
                <label
                    for="newPassword"
                    class="text-sm font-medium text-gray-300 block"
                >
                    Nueva Contraseña
                </label>
                <input
                    type="password"
                    id="newPassword"
                    name="newPassword"
                    required
                    minlength="6"
                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                />
            </div>

            <div class="space-y-2">
                <label
                    for="confirmPassword"
                    class="text-sm font-medium text-gray-300 block"
                >
                    Confirmar Nueva Contraseña
                </label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                    minlength="6"
                    class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                />
            </div>

            <div class="pt-4">
                <button
                    type="submit"
                    class="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold transition-all shadow-lg shadow-emerald-500/20"
                >
                    Cambiar Contraseña
                </button>
            </div>
        </form>
    </div>
</AdminLayout>
